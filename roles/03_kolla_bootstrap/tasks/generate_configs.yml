---
- name: Ensure /etc/kolla directory exists
  ansible.builtin.file:
    path: /etc/kolla
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"

- name: Check if passwords.yml already exists
  ansible.builtin.stat:
    path: /etc/kolla/passwords.yml
  register: passwords_file

- name: Generate Kolla passwords
  when: not passwords_file.stat.exists
  block:
    - name: Copy passwords template from kolla-ansible
      ansible.builtin.copy:
        src: /home/ansible/kolla-venv/share/kolla-ansible/etc_examples/kolla/passwords.yml
        dest: /etc/kolla/passwords.yml
        owner: ansible
        group: ansible
        mode: "0640"
        remote_src: true

    - name: Generate random passwords
      ansible.builtin.shell: |
        /home/ansible/kolla-venv/bin/kolla-genpwd -p /etc/kolla/passwords.yml
      become: true
      become_user: ansible
      environment:
        PATH: "/home/ansible/kolla-venv/bin:{{ ansible_env.PATH }}"

- name: Ensure passwords.yml is readable
  ansible.builtin.file:
    path: /etc/kolla/passwords.yml
    mode: "0640"
    owner: ansible
    group: ansible

- name: Create globals.yml from template
  ansible.builtin.template:
    src: globals.yml.j2
    dest: /etc/kolla/globals.yml
    owner: ansible
    group: ansible
    mode: "0644"

- name: Create Kolla inventory directory
  ansible.builtin.file:
    path: /etc/ansible/inventory
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"

- name: Create Kolla inventory file
  ansible.builtin.template:
    src: kolla.ini.j2
    dest: /etc/ansible/inventory/kolla.ini
    owner: ansible
    group: ansible
    mode: "0644"

- name: Ensure Kolla config subdirectories exist
  ansible.builtin.file:
    path: "/etc/kolla/config/{{ item }}"
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"
  loop:
    - nova
    - neutron
    - cinder

- name: Create nova-compute.conf for nested virtualisation
  ansible.builtin.copy:
    dest: /etc/kolla/config/nova/nova-compute.conf
    content: |
      [libvirt]
      virt_type = qemu
      cpu_mode = host-passthrough
    owner: ansible
    group: ansible
    mode: "0644"

- name: Ensure log directory exists
  ansible.builtin.file:
    path: /var/log/kolla
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"

- name: Create ansible log file
  ansible.builtin.file:
    path: /var/log/kolla/ansible.log
    state: touch
    owner: ansible
    group: ansible
    mode: "0644"
    modification_time: preserve
    access_time: preserve
