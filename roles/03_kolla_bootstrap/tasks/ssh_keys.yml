---
- name: Check if SSH key exists
  ansible.builtin.stat:
    path: /home/ansible/.ssh/id_ed25519
  register: ssh_key_check

- name: Generate SSH key if not exists
  ansible.builtin.command:
    cmd: ssh-keygen -t ed25519 -f /home/ansible/.ssh/id_ed25519 -N ''
    creates: /home/ansible/.ssh/id_ed25519
  become: true
  become_user: ansible
  when: not ssh_key_check.stat.exists

- name: Read public key
  ansible.builtin.slurp:
    src: /home/ansible/.ssh/id_ed25519.pub
  register: ssh_public_key

- name: Distribute SSH key to all OpenStack nodes
  ansible.posix.authorized_key:
    user: ansible
    key: "{{ ssh_public_key.content | b64decode }}"
    state: present
  delegate_to: "{{ item }}"
  loop: "{{ groups['vms'] }}"
